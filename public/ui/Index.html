<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        if (!localStorage.getItem('token')) {
            window.location.href = 'login.html'; // Redirect jika belum login
        }
    </script>
</head>

<body>
    <!-- sidebar -->
    <div class="">
        <span class="absolute text-white text-4xl top-5 left-4 cursor-pointer" onclick="openSidebar()">
            <i class="bi bi-filter-left px-2 bg-gray-900 rounded-md"></i>
        </span>
        <div class="sidebar fixed top-0 bottom-0 lg:left-0 p-2 w-[300px] overflow-y-auto text-center bg-gray-900">
            <div class="text-gray-100 text-xl">
                <div class="p-2.5 mt-1 flex items-center">
                    <i class="bi bi-app-indicator px-2 py-1 rounded-md bg-blue-600"></i>
                    <h1 class="font-bold text-gray-200 text-[15px] ml-3">Todo App</h1>
                    <i class="bi bi-x cursor-pointer ml-28 lg:hidden" onclick="openSidebar()"></i>
                </div>
                <div class="my-2 bg-gray-600 h-[1px]"></div>
            </div>

            <div
                class="p-2.5 mt-3 flex items-center rounded-md px-4 duration-300 cursor-pointer hover:bg-blue-600 text-white">
                <i class="bi bi-house-door-fill"></i>
                <span class="text-[15px] ml-4 text-gray-200 font-bold">Todos</span>
            </div>

            <div class="my-4 bg-gray-600 h-[1px]"></div>

            <div class="text-left text-sm mt-2 w-4/5 mx-auto text-gray-200 font-bold" id="submenu">
                <h1 class="cursor-pointer p-2 hover:bg-blue-600 rounded-md mt-1">
                    Social
                </h1>
                <h1 class="cursor-pointer p-2 hover:bg-blue-600 rounded-md mt-1">
                    Personal
                </h1>
                <h1 class="cursor-pointer p-2 hover:bg-blue-600 rounded-md mt-1">
                    Friends
                </h1>
            </div>
            <div
                class="bg-red-500 p-2.5 mt-3 flex items-center rounded-md px-4 duration-300 cursor-pointer  hover:bg-blue-600 text-white">
                <i class="bi bi-box-arrow-in-right"></i>
                <button id="logoutBtn" class="text-[15px] ml-4 text-gray-200 font-bold mx-auto">Logout</button>
            </div>
        </div>

        <script type="text/javascript">
            function dropdown() {
                document.querySelector("#submenu").classList.toggle("hidden");
                document.querySelector("#arrow").classList.toggle("rotate-0");
            }
            dropdown();

            function openSidebar() {
                document.querySelector(".sidebar").classList.toggle("hidden");
            }
        </script>
    </div>

    <div class="bg-white  flex flex-col items-center p-4 ml-56">
        <div class="w-full max-w-3xl bg-white shadow-md rounded-lg p-6 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-black">My Todo</h1>
                <button id="addTodoBtn"
                    class="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-600 transition duration-300">
                    <i class="fas fa-plus"></i> Tambah Todo
                </button>
            </div>
            <!-- Modal Form untuk tambah task -->
            <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
                <div class="bg-white p-6 rounded-xl shadow-lg w-80 relative">
                    <button id="closeTaskModal"
                        class="absolute top-2 right-2 text-gray-500 hover:text-red-500">&times;</button>
                    <h2 class="text-xl font-bold mb-4 text-center">Tambah Task</h2>

                    <form id="taskForm">
                        <input type="hidden" id="taskTodoId">
                        <div class="mb-3">
                            <label for="taskTitle" class="block text-sm font-medium text-gray-700">Judul Task</label>
                            <input type="text" id="taskTitle"
                                class="w-full border rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                required>
                        </div>

                        <div class="mb-3">
                            <label for="taskProgress" class="block text-sm font-medium text-gray-700">Progress
                                (%)</label>
                            <input type="number" id="taskProgress" class="w-full border rounded-md p-2" min="0"
                                max="100" required>
                        </div>

                        <button type="submit"
                            class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition duration-300">Simpan
                            Task</button>
                    </form>
                </div>
            </div>


            <!-- Modal Form untuk tambah task -->
            <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
                <div class="bg-white p-6 rounded-xl shadow-lg w-80 relative">
                    <button id="closeTaskModal"
                        class="absolute top-2 right-2 text-gray-500 hover:text-red-500">&times;</button>
                    <h2 class="text-xl font-bold mb-4 text-center">Tambah Task</h2>

                    <form id="taskForm">
                        <input type="hidden" id="taskTodoId">
                        <div class="mb-3">
                            <label for="taskTitle" class="block text-sm font-medium text-gray-700">Judul Task</label>
                            <input type="text" id="taskTitle"
                                class="w-full border rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                required>
                        </div>

                        <div class="mb-3">
                            <label for="taskProgress" class="block text-sm font-medium text-gray-700">Progress
                                (%)</label>
                            <input type="number" id="taskProgress" class="w-full border rounded-md p-2" min="0"
                                max="100" required>
                        </div>

                        <div class="mb-3">
                            <label for="taskStatus" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="taskStatus" class="w-full border rounded-md p-2">
                                <option value="in progress">In Progress</option>
                                <option value="done">Done</option>
                            </select>
                        </div>

                        <button type="submit"
                            class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition duration-300">Simpan
                            Task</button>
                    </form>
                </div>
            </div>


            <!-- <div class="mb-6">
                <h2 class="text-xl font-semibold mb-2" id="formTitle">Tambah Todo Baru</h2>
                <form id="todoForm" class="space-y-4">
                    <input type="hidden" id="todoId">
                    <div>
                        <label for="name" class="block text-sm font-medium">Nama Todo:</label>
                        <input type="text" id="name" name="name" required
                            class="w-full p-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
                    </div>
                    <div>
                        <label for="progress" class="block text-sm font-medium">Progress (%):</label>
                        <input type="number" id="progress" name="progress" min="0" max="100" required
                            class="w-full p-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
                    </div>
                    <div>
                        <label for="status" class="block text-sm font-medium">Status:</label>
                        <select id="status" name="status" required
                            class="w-full p-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
                            <option value="in progress">In Progress</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                    <button type="submit" id="submitBtn"
                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Tambah Todo</button>
                    <button type="button" id="cancelEdit"
                        class="hidden bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Batal Edit</button>
                </form>
            </div> -->

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4" id="todoList"></div>

        </div>

        <script>
            const API_URL = 'http://192.168.1.6:8000/api/todos';
            const TOKEN = localStorage.getItem('token');

            // Set Authorization Header
            $.ajaxSetup({
                headers: { 'Authorization': `Bearer ${TOKEN}` }
            });

            // Fetch Todos
            function getTodos() {
                $.ajax({
                    url: API_URL,
                    type: 'GET',
                    success: function (todos) {
                        $('#todoList').empty();
                        todos.forEach((todo, index) => {
                            let todoCard = `
                <div class="bg-white shadow-md rounded-lg p-4 border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800">${todo.name}</h3>
                    <p class="text-gray-600 mt-2">Progress: <strong>${todo.progress}%</strong></p>
                    <p class="text-sm text-gray-500">Status: ${todo.status}</p>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="editTodo(${todo.id})" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Edit</button>
                        <button onclick="deleteTodo(${todo.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Hapus</button>
                        <button onclick="showAddTaskModal(${todo.id})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Tambah Task</button>
                    </div>
                `;

                            // Loop through tasks related to this todo
                            if (todo.tasks && todo.tasks.length > 0) {
                                todoCard += '<div class="mt-4 space-y-2">';
                                todo.tasks.forEach((task) => {
                                    todoCard += `
                        <div class="p-2 border rounded-md bg-gray-50">
                            <p class="font-semibold">${task.title}</p>
                            <p class="text-sm text-gray-500">Progress: ${task.progress}%</p>
                        </div>
                    `;
                                });
                                todoCard += '</div>';
                            } else {
                                todoCard += '<p class="mt-2 text-gray-500">Tidak ada tasks untuk todo ini.</p>';
                            }

                            // Close todo card
                            todoCard += `</div>`;

                            // Add the todo card to the todo list
                            $('#todoList').append(todoCard);
                        });
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) {
                            window.location.href = 'login.html';
                        }
                    }
                });
            }



            $(document).ready(function () {
                // Tampilkan Modal
                $('#addTodoBtn').click(function () {
                    $('#todoModal').removeClass('hidden').addClass('flex');
                });

                // Tutup Modal
                $('#closeModal').click(function () {
                    $('#todoModal').addClass('hidden');
                    resetForm();
                });

                // Tutup Modal jika klik di luar form
                $('#todoModal').click(function (e) {
                    if (e.target.id === 'todoModal') {
                        $(this).addClass('hidden');
                        resetForm();
                    }
                });

                // Reset Form
                function resetForm() {
                    $('#todoForm')[0].reset();
                    $('#todoId').val('');
                }

                // Submit Form
                $('#todoForm').submit(function (e) {
                    e.preventDefault();
                    const todoId = $('#todoId').val();
                    const todoData = {
                        name: $('#name').val(),
                        progress: parseInt($('#progress').val()),
                        status: $('#status').val(),
                    };

                    if (todoId) {
                        // Update Todo
                        $.ajax({
                            url: `${API_URL}/${todoId}`,
                            type: 'PUT',
                            contentType: 'application/json',
                            data: JSON.stringify(todoData),
                            success: function () {
                                alert('Todo berhasil diperbarui!');
                                resetForm();
                                $('#todoModal').addClass('hidden');
                                getTodos();
                            },
                            error: function (xhr) {
                                console.log(xhr.responseText);
                                alert('Gagal memperbarui todo.');
                            }
                        });
                    } else {
                        // Tambah Todo Baru
                        $.ajax({
                            url: API_URL,
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(todoData),
                            success: function () {
                                alert('Todo berhasil ditambahkan!');
                                resetForm();
                                $('#todoModal').addClass('hidden');
                                getTodos();
                            },
                            error: function (xhr) {
                                console.log(xhr.responseText);
                                alert('Gagal menambahkan todo.');
                            }
                        });
                    }
                });
            });


            // Hapus Todo
            function deleteTodo(id) {
                if (confirm('Apakah yakin ingin menghapus todo ini?')) {
                    $.ajax({
                        url: `${API_URL}/${id}`,
                        type: 'DELETE',
                        success: function () {
                            alert('Todo berhasil dihapus!');
                            getTodos();
                        }
                    });
                }
            }

            // Edit Todo
            function editTodo(id) {
                $.ajax({
                    url: `${API_URL}/${id}`,
                    type: 'GET',
                    success: function (todo) {
                        $('#formTitle').text('Edit Todo');
                        $('#submitBtn').text('Perbarui Todo');
                        $('#cancelEdit').removeClass('hidden');

                        $('#todoId').val(todo.id);
                        $('#name').val(todo.name);
                        $('#progress').val(todo.progress);
                        $('#status').val(todo.status);
                    },
                    error: function () {
                        alert('Gagal mengambil data todo.');
                    }
                });
            }

            // Reset Form
            function resetForm() {
                $('#formTitle').text('Tambah Todo Baru');
                $('#submitBtn').text('Tambah Todo');
                $('#cancelEdit').addClass('hidden');

                $('#todoForm')[0].reset();
                $('#todoId').val('');
            }

            // Batal Edit
            $('#cancelEdit').click(function () {
                resetForm();
            });

            // Fungsi untuk menampilkan modal form
            function showAddTaskModal(todoId) {
                // Menetapkan ID todo ke input hidden
                $('#taskTodoId').val(todoId);

                // Menampilkan modal
                $('#taskModal').removeClass('hidden');
            }

            // Fungsi untuk menutup modal form
            $('#closeTaskModal').on('click', function () {
                $('#taskModal').addClass('hidden');
            });

            // Menangani pengiriman form
            $('#taskForm').on('submit', function (e) {
                e.preventDefault();

                // Mengambil data dari form
                const todoId = $('#taskTodoId').val();
                const taskTitle = $('#taskTitle').val();
                const taskProgress = $('#taskProgress').val();
                const taskStatus = $('#taskStatus').val();

                // Mendapatkan user_id, misalnya dari sesi atau token yang disimpan
                const userId = getUserId(); // Fungsi untuk mendapatkan ID pengguna yang sedang login

                // Data yang akan dikirim ke API
                const taskData = {
                    title: taskTitle,
                    progress: taskProgress,
                    parent_id: null,
                    todo_id: todoId,
                    user_id: userId,
                    status: taskStatus
                };

                // Mengirimkan data ke API menggunakan AJAX
                $.ajax({
                    url: `http://192.168.1.6:8000/api/tasks/${todoId}`,
                    type: 'POST',
                    data: taskData,
                    success: function (response) {
                        // Menutup modal setelah task ditambahkan
                        $('#taskModal').addClass('hidden');

                        // Menampilkan notifikasi atau pembaruan UI setelah task berhasil ditambahkan
                        alert('Task berhasil ditambahkan!');
                    },
                    error: function (xhr, status, error) {
                        // Menampilkan pesan error jika terjadi kesalahan
                        alert('Gagal menambahkan task: ' + error);
                    }
                });
            });

            // Fungsi untuk mendapatkan user_id, bisa disesuaikan dengan cara kamu mendapatkan ID pengguna yang sedang login
            function getUserId() {
                // Misalnya, user_id disimpan di localStorage atau sessionStorage
                return localStorage.getItem('user_id'); // Gantilah sesuai dengan implementasi login kamu
            }




            // Tutup Modal
            $('#closeTaskModal').click(function () {
                $('#taskModal').addClass('hidden');
                resetTaskForm();
            });

            // Tutup Modal jika klik di luar form
            $('#taskModal').click(function (e) {
                if (e.target.id === 'taskModal') {
                    $(this).addClass('hidden');
                    resetTaskForm();
                }
            });

            // Reset Form
            function resetTaskForm() {
                $('#taskForm')[0].reset();
                $('#taskTodoId').val('');
            }

            // Submit Form untuk tambah task
            $('#taskForm').submit(function (e) {
                e.preventDefault();

                const taskData = {
                    title: $('#taskTitle').val(),
                    progress: parseInt($('#taskProgress').val()),
                };

                const todoId = $('#taskTodoId').val();  // Ambil ID todo yang telah disimpan

                // Kirim data task baru ke API
                $.ajax({
                    url: `${API_URL}/${todoId}/tasks`,  // Pastikan API URL sesuai dengan yang diterima backend
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(taskData),
                    success: function (response) {
                        alert('Task berhasil ditambahkan!');
                        $('#taskModal').addClass('hidden');
                        getTodos(); // Refresh Todo list untuk menampilkan task yang baru ditambahkan
                    },
                    error: function (xhr, status, error) {
                        // Menampilkan error yang lebih jelas
                        let errorMessage = 'Gagal menambahkan task.';
                        if (xhr.status === 400) {
                            errorMessage = 'Data yang dikirim tidak valid. Silakan periksa inputan Anda.';
                        } else if (xhr.status === 401) {
                            errorMessage = 'Anda tidak terautentikasi. Silakan login terlebih dahulu.';
                        } else if (xhr.status === 500) {
                            errorMessage = 'Terjadi masalah di server. Silakan coba lagi nanti.';
                        } else if (error) {
                            errorMessage = `Error: ${error}`;
                        }

                        console.error(`Status: ${xhr.status}, Error: ${errorMessage}`);
                        alert(errorMessage);
                    }
                });
            });





            // Logout
            $('#logoutBtn').click(function () {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            });

            // Load Todos saat halaman terbuka
            $(document).ready(function () {
                getTodos();
            });


            function fetchTasks(todoId) {
                $.ajax({
                    url: `${API_URL}/${todoId}/tasks`,
                    type: 'GET',
                    success: function (tasks) {
                        // Menampilkan tasks terkait dalam card atau modal (sesuai kebutuhan)
                        let taskListHTML = `<div class="mt-3 space-y-2">`;

                        tasks.forEach((task) => {
                            taskListHTML += `
                                <div class="p-2 border rounded-md bg-gray-50">
                                    <p class="font-semibold">${task.title}</p>
                                    <p class="text-sm text-gray-500">Progress: ${task.progress}%</p>
                                </div>
                            `;
                        });

                        taskListHTML += '</div>';

                        // Update bagian tasks di card sesuai dengan todoId
                        $(`#tasks-${todoId}`).html(taskListHTML); // Bisa juga ditampilkan dalam modal
                    },
                    error: function (xhr) {
                        console.log(xhr.responseText);
                        alert('Gagal memuat tasks.');
                    }
                });
            }

        </script>
    </div>
</body>


</html>